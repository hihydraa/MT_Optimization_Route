<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Route Optimization Dashboard (Comparison + Actual)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #111827; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

    /* Leaflet popup */
    .leaflet-popup-content { font-family: 'Sarabun', sans-serif; }

    /* Mini legend */
    .legend-box {
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
      font-family: 'Sarabun', sans-serif;
    }
    .legend-row { display:flex; align-items:center; gap:8px; margin:4px 0; }
    .legend-dot { width:10px; height:10px; border-radius:999px; border:1px solid #fff; }
    .legend-swatch { width:12px; height:12px; border-radius:3px; border:1px solid rgba(0,0,0,0.12); }
  </style>
</head>

<body>
  <!-- Loading Overlay -->
  <div id="loading" class="fixed inset-0 bg-white/95 z-[9999] flex flex-col justify-center items-center">
    <div class="spinner mb-4"></div>
    <h2 class="text-xl font-bold text-gray-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h2>
    <p class="text-gray-500 text-sm mt-2">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
    <div id="error-msg" class="hidden mt-4 p-4 bg-red-100 text-red-700 rounded-lg border border-red-200 max-w-md text-center"></div>
    <button id="btnRetry" class="hidden mt-4 px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800" onclick="location.reload()">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
  </div>

  <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <div class="text-center mb-8">
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Dashboard ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏£‡∏ñ</h1>
      <p class="text-gray-500 mt-2">Before (Current) vs After (K-Means) + View Points by Actual Truck</p>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏° (Total Dist.)</h3>
        <div class="mt-1 flex items-baseline gap-2">
          <span class="text-2xl font-bold text-gray-900" id="dist-after">-</span>
        </div>
        <div class="text-xs text-gray-400 mt-1">‡πÄ‡∏î‡∏¥‡∏°: <span id="dist-before">-</span> km</div>
      </div>

      <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á (Est. Cost)</h3>
        <div class="mt-1 flex items-baseline gap-2">
          <span class="text-2xl font-bold text-gray-900" id="cost-after">-</span>
        </div>
        <div class="text-xs text-gray-400 mt-1">‡πÄ‡∏î‡∏¥‡∏°: <span id="cost-before">-</span> ‡∏ö‡∏≤‡∏ó</div>
      </div>

      <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
        <h3 class="text-xs font-bold text-green-600 uppercase tracking-wider">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏î‡πÑ‡∏î‡πâ (Savings)</h3>
        <div class="mt-1 flex items-baseline gap-2">
          <span class="text-2xl font-bold text-green-600" id="savings">-</span>
          <span class="text-sm font-medium text-green-500" id="savings-pct"></span>
        </div>
        <div class="text-xs text-green-500 mt-1">‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á (Per Round)</div>
      </div>

      <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏ã‡∏ô</h3>
        <div class="mt-1 flex items-baseline gap-2">
          <span class="text-2xl font-bold text-orange-500" id="changed-count">-</span>
          <span class="text-sm text-gray-500">‡∏£‡∏≤‡∏¢</span>
        </div>
        <div class="text-xs text-gray-400 mt-1">‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="total-count">-</span> ‡∏£‡∏≤‡∏¢</div>
      </div>
    </div>

    <!-- Map Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden mb-8 relative">
      <div class="p-4 border-b border-gray-100 bg-gray-50 flex flex-wrap justify-between items-center gap-4">
        <h3 class="font-bold text-gray-800">üìç ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏ã‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Service Zones)</h3>

        <!-- 3-mode toggle -->
        <div class="flex bg-gray-200 rounded-lg p-1">
          <button id="btnViewOld"
            class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-600 hover:text-gray-900"
            onclick="switchView('old')">Current (‡πÄ‡∏î‡∏¥‡∏°)</button>

          <button id="btnViewNew"
            class="px-4 py-1.5 rounded-md text-sm font-medium transition-all bg-white text-gray-900 shadow-sm"
            onclick="switchView('new')">K-Means (‡πÉ‡∏´‡∏°‡πà)</button>

          <button id="btnViewActual"
            class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-600 hover:text-gray-900"
            onclick="switchView('actual')">Actual (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</button>
        </div>
      </div>

      <div id="map" class="h-[600px] w-full z-0"></div>
    </div>

    <!-- Table Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
      <div class="p-5 border-b border-gray-100">
        <h3 class="font-bold text-gray-800">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (Customer Details)</h3>
        <p class="text-xs text-gray-500 mt-1">K-Means Zone (‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà) + Current/Actual (‡∏à‡∏∏‡∏î) + ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏ñ</p>
      </div>
      <div class="overflow-x-auto custom-scrollbar">
        <table class="w-full text-sm text-left">
          <thead class="bg-gray-50 text-gray-500 font-medium border-b">
            <tr>
              <th class="px-6 py-3 whitespace-nowrap">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
              <th class="px-6 py-3 whitespace-nowrap text-right">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (‡∏•‡∏¥‡∏ï‡∏£)</th>
              <th class="px-6 py-3 whitespace-nowrap">‡∏£‡∏ñ‡πÄ‡∏î‡∏¥‡∏° (Current)</th>
              <th class="px-6 py-3 whitespace-nowrap">‡πÇ‡∏ã‡∏ô K-Means</th>
              <th class="px-6 py-3 whitespace-nowrap">‡∏£‡∏ñ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Actual)</th>
              <th class="px-6 py-3 whitespace-nowrap text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-gray-100"></tbody>
        </table>
      </div>
      <div class="p-4 border-t border-gray-100 bg-gray-50 text-center">
        <p class="text-xs text-gray-400">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 500 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // CONFIGURATION
    // ==========================================
    const SHEET_ID = "19x1T9hf0GsTaT5DFKAk7-51A7s6PCd_Ty6P5X9n3A9M";
    const SHEET_NAME = "dataset";

    const FUEL_PRICE = 30;      // ‡∏ö‡∏≤‡∏ó/‡∏•‡∏¥‡∏ï‡∏£ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£)
    const FUEL_CONSUMPTION = 4; // ‡∏Å‡∏°./‡∏•‡∏¥‡∏ï‡∏£ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£)

    // Global State
    let globalData = [];
    let globalDepot = { lat: 0, lng: 0 };
    let map;
    let layerGroup; // For Markers & Polygons
    let legendControl;
    let currentViewMode = 'new'; // 'old' | 'new' | 'actual'

    // ==========================================
    // UTILS
    // ==========================================
    function pick(obj, keys, fallback = null) {
      for (const k of keys) {
        if (obj && Object.prototype.hasOwnProperty.call(obj, k) && obj[k] !== null && obj[k] !== undefined && obj[k] !== "") {
          return obj[k];
        }
      }
      return fallback;
    }

    function toStr(v, fallback = "Unknown") {
      if (v === null || v === undefined) return fallback;
      const s = String(v).trim();
      return s ? s : fallback;
    }

    function toNum(v, fallback = 0) {
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    }

    // Convex Hull (Monotone Chain)
    function convexHull(points) {
      const pts = [...points].sort((a, b) => a.lat !== b.lat ? a.lat - b.lat : a.lng - b.lng);
      const cross = (a, b, o) => (a.lat - o.lat) * (b.lng - o.lng) - (a.lng - o.lng) * (b.lat - o.lat);
      const upper = [], lower = [];
      for (const p of pts) {
        while (upper.length >= 2 && cross(upper[upper.length - 2], upper[upper.length - 1], p) <= 0) upper.pop();
        upper.push(p);
      }
      for (const p of pts.reverse()) {
        while (lower.length >= 2 && cross(lower[lower.length - 2], lower[lower.length - 1], p) <= 0) lower.pop();
        lower.push(p);
      }
      // remove last duplicated points if any
      const hull = [...upper, ...lower];
      return hull;
    }

    // Haversine
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // Simple nearest-neighbor "route" estimate (approx)
    function calculateRouteCost(points, depot) {
      if (!points.length) return 0;
      let unvisited = [...points];
      let current = depot;
      let totalDist = 0;

      while (unvisited.length > 0) {
        let nearestIdx = -1, minDst = Infinity;
        for (let i = 0; i < unvisited.length; i++) {
          const d = getDistance(current.lat, current.lng, unvisited[i].lat, unvisited[i].lng);
          if (d < minDst) { minDst = d; nearestIdx = i; }
        }
        totalDist += minDst;
        current = unvisited[nearestIdx];
        unvisited.splice(nearestIdx, 1);
      }
      totalDist += getDistance(current.lat, current.lng, depot.lat, depot.lng);
      return totalDist;
    }

    // ==========================================
    // DATA FETCHING
    // ==========================================
    async function fetchSheet(sheetName, sheetId = SHEET_ID) {
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&tq=`;
      const res = await fetch(url);
      const text = await res.text();
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
      const cols = json.table.cols.map(c => c ? (c.label || c.id) : "");
      return json.table.rows.map(r => {
        const obj = {};
        cols.forEach((colName, i) => {
          if (!colName) return;
          obj[colName] = (r.c && r.c[i]) ? r.c[i].v : null;
        });
        return obj;
      });
    }

    // ==========================================
    // MAIN INIT
    // ==========================================
    async function initDashboard() {
      try {
        const rawData = await fetchSheet(SHEET_NAME);
        if (!rawData.length) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó dataset");

        // Column name fallbacks (‡∏Å‡∏±‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡πà‡∏≤‡∏á)
        const LAT_KEYS = ["latitude", "lat", "Latitude", "LAT"];
        const LNG_KEYS = ["longitude", "lng", "Longitude", "LNG", "long"];
        const NAME_KEYS = ["customer_name", "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "Customer", "name", "‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏£‡πâ‡∏≤‡∏ô"];
        const SALE_KEYS = ["sale_per_wk", "sale_per_week", "‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå", "sale_week", "sale_wk"];
        const OLD_TRUCK_KEYS = ["current_truck_id", "current_truck", "Current_truck", "truck_current"];
        const KMEANS_KEYS = ["assigned_truck_K-Means", "assigned_truck_K-Means ", "assigned_truck_K_Means", "assigned_truck_kmeans", "assigned_truck_KMeans", "assigned_truck_K-Means\n"];
        const ACTUAL_KEYS = ["Actual_truck", "actual_truck", "ACTUAL_TRUCK", "truck_actual"];

        // Process & filter only valid lat/lng
        globalData = rawData.map(d => {
          const lat = toNum(pick(d, LAT_KEYS), NaN);
          const lng = toNum(pick(d, LNG_KEYS), NaN);

          return {
            lat, lng,
            name: toStr(pick(d, NAME_KEYS), "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"),
            sale: toNum(pick(d, SALE_KEYS), 0),
            oldTruck: toStr(pick(d, OLD_TRUCK_KEYS), "Unknown"),
            newTruck: toStr(pick(d, KMEANS_KEYS), "Unknown"),
            actualTruck: toStr(pick(d, ACTUAL_KEYS), "Unknown"),
          };
        }).filter(x => Number.isFinite(x.lat) && Number.isFinite(x.lng));

        if (!globalData.length) throw new Error("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î latitude/longitude ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ");

        // Depot = centroid
        globalDepot = {
          lat: globalData.reduce((s, d) => s + d.lat, 0) / globalData.length,
          lng: globalData.reduce((s, d) => s + d.lng, 0) / globalData.length
        };

        // Init map
        map = L.map('map').setView([globalDepot.lat, globalDepot.lng], 9);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        layerGroup = L.layerGroup().addTo(map);

        // Depot marker
        L.marker([globalDepot.lat, globalDepot.lng], {
          icon: L.divIcon({
            className: '',
            html: '<div style="background:black;width:14px;height:14px;border:2px solid white;border-radius:50%;box-shadow:0 0 5px black;"></div>'
          })
        }).addTo(map).bindPopup("<b>Depot</b>");

        calculateStats();
        renderMap();
        renderTable();

        document.getElementById('loading').style.display = 'none';

      } catch (err) {
        document.getElementById('error-msg').innerText = err?.message || String(err);
        document.getElementById('error-msg').classList.remove('hidden');
        document.getElementById('btnRetry').classList.remove('hidden');
      }
    }

    // ==========================================
    // STATS (Old vs New only)
    // ==========================================
    function calculateStats() {
      const groupsOld = {}, groupsNew = {};
      let changedCount = 0;

      globalData.forEach(d => {
        if (!groupsOld[d.oldTruck]) groupsOld[d.oldTruck] = [];
        groupsOld[d.oldTruck].push(d);

        if (!groupsNew[d.newTruck]) groupsNew[d.newTruck] = [];
        groupsNew[d.newTruck].push(d);

        if (d.oldTruck !== d.newTruck) changedCount++;
      });

      let distOld = 0;
      Object.values(groupsOld).forEach(g => distOld += calculateRouteCost(g, globalDepot));
      let distNew = 0;
      Object.values(groupsNew).forEach(g => distNew += calculateRouteCost(g, globalDepot));

      const costOld = (distOld / FUEL_CONSUMPTION) * FUEL_PRICE;
      const costNew = (distNew / FUEL_CONSUMPTION) * FUEL_PRICE;
      const savings = costOld - costNew;

      document.getElementById('dist-before').innerText = distOld.toLocaleString('th-TH', { maximumFractionDigits: 0 });
      document.getElementById('dist-after').innerText = distNew.toLocaleString('th-TH', { maximumFractionDigits: 0 }) + " km";
      document.getElementById('cost-before').innerText = costOld.toLocaleString('th-TH', { maximumFractionDigits: 0 });
      document.getElementById('cost-after').innerText = costNew.toLocaleString('th-TH', { maximumFractionDigits: 0 }) + " ‡∏ö‡∏≤‡∏ó";
      document.getElementById('savings').innerText = savings.toLocaleString('th-TH', { maximumFractionDigits: 0 }) + " ‡∏ö‡∏≤‡∏ó";
      document.getElementById('savings-pct').innerText = costOld > 0 ? `(${((savings / costOld) * 100).toFixed(1)}%)` : "";
      document.getElementById('changed-count').innerText = changedCount.toLocaleString('th-TH');
      document.getElementById('total-count').innerText = globalData.length.toLocaleString('th-TH');
    }

    // ==========================================
    // VIEW SWITCH
    // ==========================================
    function switchView(mode) {
      currentViewMode = mode;

      const btnOld = document.getElementById('btnViewOld');
      const btnNew = document.getElementById('btnViewNew');
      const btnActual = document.getElementById('btnViewActual');

      const activeClass = ['bg-white', 'text-gray-900', 'shadow-sm'];
      const inactiveClass = ['bg-transparent', 'text-gray-600'];

      [btnOld, btnNew, btnActual].forEach(b => {
        b.classList.remove(...activeClass);
        b.classList.add(...inactiveClass);
      });

      const activeBtn = mode === 'old' ? btnOld : mode === 'new' ? btnNew : btnActual;
      activeBtn.classList.add(...activeClass);
      activeBtn.classList.remove(...inactiveClass);

      renderMap();
    }

    // ==========================================
    // MAP RENDER
    // Requirement:
    // - Zones Highlight = K-Means (always)
    // - Points = depends on view (old/new/actual)
    // ==========================================
    function renderMap() {
      layerGroup.clearLayers();

      // Remove old legend if exists
      if (legendControl) {
        try { map.removeControl(legendControl); } catch (e) {}
        legendControl = null;
      }

      // A) Zones = K-Means
      const groupsKmeans = {};
      globalData.forEach(d => {
        const zid = d.newTruck;
        if (!groupsKmeans[zid]) groupsKmeans[zid] = [];
        groupsKmeans[zid].push(d);
      });

      const zoneColors = [
        '#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4',
        '#46f0f0','#f032e6','#bcf60c','#008080','#9a6324','#800000',
        '#000075','#808000','#ffd8b1','#aaffc3'
      ];

      const kmeansColor = {};
      Object.keys(groupsKmeans).sort().forEach((id, i) => kmeansColor[id] = zoneColors[i % zoneColors.length]);

      Object.keys(groupsKmeans).forEach(kid => {
        const pts = groupsKmeans[kid];
        const color = kmeansColor[kid];

        if (pts.length >= 3) {
          const hull = convexHull(pts.map(p => ({ lat: p.lat, lng: p.lng })));
          L.polygon(hull.map(p => [p.lat, p.lng]), {
            color,
            weight: 2,
            opacity: 0.75,
            fillColor: color,
            fillOpacity: 0.18
          }).addTo(layerGroup).bindPopup(`<b>K-Means Zone</b><br>${kid}<br>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${pts.length} ‡∏£‡∏≤‡∏¢`);
        } else if (pts.length === 2) {
          L.polyline(pts.map(p => [p.lat, p.lng]), {
            color,
            weight: 2,
            opacity: 0.75,
            dashArray: '5, 5'
          }).addTo(layerGroup).bindPopup(`<b>K-Means Zone</b><br>${kid}<br>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 2 ‡∏£‡∏≤‡∏¢`);
        }
      });

      // B) Points = view-based grouping
      const groupsPoints = {};
      globalData.forEach(d => {
        const tid =
          currentViewMode === 'old' ? d.oldTruck :
          currentViewMode === 'new' ? d.newTruck :
          d.actualTruck;

        if (!groupsPoints[tid]) groupsPoints[tid] = [];
        groupsPoints[tid].push(d);
      });

      const pointColors = ['#111827','#2563eb','#dc2626','#16a34a','#7c3aed','#ea580c','#0f766e','#be185d','#4b5563','#0891b2'];
      const pointColor = {};
      Object.keys(groupsPoints).sort().forEach((id, i) => pointColor[id] = pointColors[i % pointColors.length]);

      // Draw markers (Actual mode: highlight mismatch with K-Means by ring)
      Object.keys(groupsPoints).forEach(truckId => {
        const pts = groupsPoints[truckId];
        const c = pointColor[truckId];

        pts.forEach(p => {
          const mismatch = (currentViewMode === 'actual') && (p.actualTruck !== p.newTruck);

          // main dot
          const marker = L.circleMarker([p.lat, p.lng], {
            radius: 5,
            fillColor: c,
            color: '#fff',
            weight: 1,
            opacity: 1,
            fillOpacity: 0.95
          }).addTo(layerGroup);

          // ring for mismatch
          if (mismatch) {
            L.circleMarker([p.lat, p.lng], {
              radius: 8,
              fillColor: 'transparent',
              color: '#f59e0b',  // amber ring
              weight: 2,
              opacity: 0.95
            }).addTo(layerGroup);
          }

          marker.bindPopup(`
            <b>${p.name}</b><br>
            <span style="color:#6b7280;">View:</span> <b>${currentViewMode.toUpperCase()}</b><br>
            <span style="color:#6b7280;">Truck (view):</span> <b>${truckId}</b><br>
            <span style="color:#6b7280;">K-Means Zone:</span> <b>${p.newTruck}</b><br>
            <span style="color:#6b7280;">Current:</span> <b>${p.oldTruck}</b><br>
            <span style="color:#6b7280;">Actual:</span> <b>${p.actualTruck}</b><br>
            <span style="color:#6b7280;">Sale:</span> ${p.sale.toLocaleString('th-TH')} L/wk
            ${mismatch ? `<br><span style="color:#b45309;"><b>‚ö† Actual ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á K-Means</b></span>` : ``}
          `);
        });
      });

      // C) Legend
      legendControl = L.control({ position: 'bottomleft' });
      legendControl.onAdd = function() {
        const div = L.DomUtil.create('div', 'legend-box');
        const modeLabel = currentViewMode === 'old' ? 'Current (‡πÄ‡∏î‡∏¥‡∏°)' : currentViewMode === 'new' ? 'K-Means (‡πÉ‡∏´‡∏°‡πà)' : 'Actual (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)';
        div.innerHTML = `
          <div style="font-weight:700; color:#111827; margin-bottom:6px;">Legend</div>
          <div class="legend-row"><span class="legend-swatch" style="background:#ffffff;"></span><span style="color:#6b7280;">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà/‡πÇ‡∏ã‡∏ô = K-Means (Highlight)</span></div>
          <div class="legend-row"><span class="legend-dot" style="background:#111827;"></span><span style="color:#6b7280;">‡∏à‡∏∏‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ = ${modeLabel}</span></div>
          <div class="legend-row"><span class="legend-dot" style="background:transparent; border:2px solid #f59e0b; width:12px; height:12px;"></span><span style="color:#6b7280;">(Actual) ‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô = ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á K-Means</span></div>
        `;
        return div;
      };
      legendControl.addTo(map);
    }

    // ==========================================
    // TABLE
    // ==========================================
    function renderTable() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      const sortedData = [...globalData].sort((a, b) => {
        // prioritize changes: actual!=kmeans OR old!=kmeans
        const aChanged = (a.actualTruck !== a.newTruck) || (a.oldTruck !== a.newTruck) ? 0 : 1;
        const bChanged = (b.actualTruck !== b.newTruck) || (b.oldTruck !== b.newTruck) ? 0 : 1;
        return aChanged - bChanged || a.name.localeCompare(b.name);
      }).slice(0, 500);

      sortedData.forEach(d => {
        const changedOld = d.oldTruck !== d.newTruck;
        const changedActual = d.actualTruck !== d.newTruck;

        const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50 transition-colors";
        tr.innerHTML = `
          <td class="px-6 py-3 font-medium text-gray-900">
            ${d.name}
            ${changedActual ? '<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">Actual‚â†K-Means</span>' : ''}
            ${(!changedActual && changedOld) ? '<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">‡∏¢‡πâ‡∏≤‡∏¢‡πÇ‡∏ã‡∏ô</span>' : ''}
          </td>
          <td class="px-6 py-3 text-right font-mono text-gray-600">${d.sale.toLocaleString('th-TH')}</td>
          <td class="px-6 py-3 text-gray-500">${d.oldTruck}</td>
          <td class="px-6 py-3 font-bold text-indigo-700">${d.newTruck}</td>
          <td class="px-6 py-3 ${changedActual ? 'font-bold text-emerald-700' : 'text-gray-500'}">${d.actualTruck}</td>
          <td class="px-6 py-3 text-center">
            ${
              changedActual
                ? `<span class="text-xs text-gray-500">K: ${d.newTruck} ‚Üí A: <b>${d.actualTruck}</b></span>`
                : changedOld
                  ? `<span class="text-xs text-gray-400">‡πÄ‡∏î‡∏¥‡∏° ${d.oldTruck} ‚Üí K ${d.newTruck}</span>`
                  : `<span class="text-xs text-gray-300">-</span>`
            }
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Init
    initDashboard();
  </script>
</body>
</html>
