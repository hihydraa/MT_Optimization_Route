<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Optimization Dashboard (GViz)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 20px; background: #f3f4f6; color: #1f2937; }
        
        /* Header */
        .header { text-align: center; margin-bottom: 25px; }
        .header h1 { margin: 0; font-size: 1.5rem; color: #111827; }
        .header p { color: #6b7280; font-size: 0.9rem; margin-top: 5px; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
        .card h3 { margin: 0 0 8px; font-size: 0.85rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; }
        .card .value { font-size: 1.8rem; font-weight: 700; color: #111827; }
        .card .sub { font-size: 0.85rem; color: #9ca3af; margin-top: 4px; }
        .text-green { color: #059669 !important; }
        .text-red { color: #dc2626 !important; }

        /* Map */
        #map { height: 600px; width: 100%; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 4px solid white; }
        
        /* Loading & Error */
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #111827; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #error-msg { background: #fee2e2; color: #991b1b; padding: 15px; border-radius: 8px; max-width: 400px; text-align: center; display: none; border: 1px solid #fecaca; }

        /* Legend */
        .legend { background: white; padding: 10px 12px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 0.85rem; line-height: 1.5; max-height: 250px; overflow-y: auto; }
        .legend i { width: 12px; height: 12px; float: left; margin-right: 8px; margin-top: 3px; border-radius: 2px; }
        
        /* Tooltip Custom */
        .leaflet-tooltip.my-tooltip { background: #1f2937; color: white; border: none; border-radius: 6px; padding: 4px 8px; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .leaflet-tooltip-left.my-tooltip::before { border-left-color: #1f2937; }
        .leaflet-tooltip-right.my-tooltip::before { border-right-color: #1f2937; }

        .btn-retry { margin-top: 15px; padding: 8px 16px; background: #111827; color: white; border: none; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <h2 style="font-size:1.1rem; font-weight:600; color:#374151;">กำลังคำนวณเส้นทาง...</h2>
        <p style="font-size:0.9rem; color:#6b7280; margin-top:5px;">ดึงข้อมูลจาก Google  ด้วยวิธี GViz</p>
        <div id="error-msg"></div>
        <button id="btnRetry" class="btn-retry" style="display:none;" onclick="location.reload()">ลองใหม่</button>
    </div>

    <div class="header">
        <h1>Dashboard เปรียบเทียบเส้นทาง (Before vs After)</h1>
        <p>วิเคราะห์ผลลัพธ์จาก K-Means Clustering</p>
    </div>

    <div class="stats-grid">
        <div class="card">
            <h3>ระยะทางรวม (Total Distance)</h3>
            <div class="value" id="dist-after">-</div>
            <div class="sub">เดิม: <span id="dist-before">-</span> km</div>
        </div>
        <div class="card">
            <h3>ต้นทุนเชื้อเพลิง (Fuel Cost)</h3>
            <div class="value" id="cost-after">-</div>
            <div class="sub">เดิม: <span id="cost-before">-</span> THB</div>
        </div>
        <div class="card">
            <h3>ส่วนต่างที่ลดได้ (Savings)</h3>
            <div class="value text-green" id="savings">-</div>
            <div class="sub text-green" id="savings-pct">-</div>
        </div>
        <div class="card">
            <h3>ลูกค้าที่ได้รับผลกระทบ</h3>
            <div class="value" id="changed-count">-</div>
            <div class="sub">จากทั้งหมด <span id="total-count">-</span> ราย</div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        const _ID = "19x1T9hf0GsTaT5DFKAk7-51A7s6PCd_Ty6P5X9n3A9M"; // ไอดี Sheet ของคุณ
        
        // *** สำคัญ: ชื่อ Tab (Sheet Name) ต้องตรงกับในไฟล์จริง ***
        // ลองเปลี่ยนเป็น "Sheet1" หากไม่พบข้อมูล
        const SHEET_NAME = "dataset"; 

        const FUEL_PRICE = 30; // บาท/ลิตร
        const FUEL_CONSUMPTION = 4; // กม./ลิตร

        // ==========================================
        // 2. DATA FETCHING (GViz Method)
        // ==========================================
        async function fetchSheet(sheetName, sheetId = SHEET_ID) {
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&tq=`;
            
            try {
                const res = await fetch(url, { cache: "no-store" });
                if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
                
                const text = await res.text();
                // ตัดแต่ง JSON Response จาก GViz
                const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
                
                if (json.status === 'error') throw new Error(`Google Sheet Error: ${json.errors[0].message}`);

                const cols = json.table.cols.map(c => c ? (c.label || c.id) : "");
                const rows = json.table.rows.map(r => (r.c || []).map(c => c ? (c.f ?? c.v ?? "") : ""));
                
                // Map Array เป็น Object ตามชื่อคอลัมน์
                return rows.map(r => {
                    const obj = {};
                    cols.forEach((colName, i) => {
                        if(colName) obj[colName] = r[i];
                    });
                    return obj;
                });

            } catch (err) {
                console.error("Fetch Error:", err);
                throw err;
            }
        }

        // ==========================================
        // 3. CALCULATION LOGIC (TSP Heuristic)
        // ==========================================
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function calculateRoute(points, depot) {
            if (points.length === 0) return 0;
            let unvisited = [...points];
            let current = depot;
            let totalDist = 0;

            // Nearest Neighbor Algorithm
            while (unvisited.length > 0) {
                let nearestIdx = -1;
                let minDst = Infinity;

                for (let i = 0; i < unvisited.length; i++) {
                    const d = getDistance(current.lat, current.lng, unvisited[i].lat, unvisited[i].lng);
                    if (d < minDst) {
                        minDst = d;
                        nearestIdx = i;
                    }
                }
                
                totalDist += minDst;
                current = unvisited[nearestIdx];
                unvisited.splice(nearestIdx, 1);
            }
            // Return to depot
            totalDist += getDistance(current.lat, current.lng, depot.lat, depot.lng);
            return totalDist;
        }

        // ==========================================
        // 4. MAIN APP
        // ==========================================
        async function initDashboard() {
            try {
                const rawData = await fetchSheet(SHEET_NAME);
                
                if (rawData.length === 0) throw new Error("ไม่พบข้อมูลใน Sheet (อาจจะชื่อ Tab ผิด)");

                // ตรวจสอบคอลัมน์ที่จำเป็น
                const sample = rawData[0];
                const required = ['latitude', 'longitude', 'current_truck_id', 'assigned_truck_K-Means'];
                const missing = required.filter(f => sample[f] === undefined);
                
                if (missing.length > 0) {
                    throw new Error(`ไม่พบคอลัมน์: ${missing.join(', ')} <br>กรุณาตรวจสอบชื่อหัวตารางใน Google Sheet`);
                }

                // Clean Data
                const data = rawData.filter(d => d.latitude && d.longitude).map(d => ({
                    lat: parseFloat(d.latitude),
                    lng: parseFloat(d.longitude),
                    name: d.customer_name || 'ลูกค้า',
                    oldTruck: String(d.current_truck_id).trim(),
                    newTruck: String(d['assigned_truck_K-Means']).trim()
                }));

                // Calculate Depot (Centroid)
                const depot = {
                    lat: data.reduce((s, d) => s + d.lat, 0) / data.length,
                    lng: data.reduce((s, d) => s + d.lng, 0) / data.length
                };

                // Group Data
                const groupsOld = {}, groupsNew = {};
                let changedCount = 0;

                data.forEach(d => {
                    if (!groupsOld[d.oldTruck]) groupsOld[d.oldTruck] = [];
                    groupsOld[d.oldTruck].push(d);

                    if (!groupsNew[d.newTruck]) groupsNew[d.newTruck] = [];
                    groupsNew[d.newTruck].push(d);

                    if (d.oldTruck !== d.newTruck) changedCount++;
                });

                // Calculate Stats
                let distOld = 0;
                Object.values(groupsOld).forEach(g => distOld += calculateRoute(g, depot));
                
                let distNew = 0;
                Object.values(groupsNew).forEach(g => distNew += calculateRoute(g, depot));

                const costOld = (distOld / FUEL_CONSUMPTION) * FUEL_PRICE;
                const costNew = (distNew / FUEL_CONSUMPTION) * FUEL_PRICE;
                const savings = costOld - costNew;

                // Update UI
                document.getElementById('dist-before').innerText = distOld.toLocaleString('th-TH', {maximumFractionDigits: 0});
                document.getElementById('dist-after').innerText = distNew.toLocaleString('th-TH', {maximumFractionDigits: 0}) + " km";
                
                document.getElementById('cost-before').innerText = costOld.toLocaleString('th-TH', {maximumFractionDigits: 0});
                document.getElementById('cost-after').innerText = costNew.toLocaleString('th-TH', {maximumFractionDigits: 0}) + " ฿";
                
                const savingsEl = document.getElementById('savings');
                savingsEl.innerText = savings.toLocaleString('th-TH', {maximumFractionDigits: 0}) + " ฿";
                if(savings < 0) { savingsEl.classList.remove('text-green'); savingsEl.classList.add('text-red'); }

                document.getElementById('savings-pct').innerText = `(${((savings/costOld)*100).toFixed(1)}%)`;
                
                document.getElementById('total-count').innerText = data.length;
                document.getElementById('changed-count').innerText = changedCount;

                // Render Map
                renderMap(data, depot, groupsNew);

                document.getElementById('loading').style.display = 'none';

            } catch (err) {
                const errBox = document.getElementById('error-msg');
                errBox.style.display = 'block';
                errBox.innerHTML = `<strong>เกิดข้อผิดพลาด:</strong><br>${err.message}`;
                document.querySelector('.spinner').style.display = 'none';
                document.getElementById('btnRetry').style.display = 'block';
            }
        }

        function renderMap(data, depot, groups) {
            const map = L.map('map').setView([depot.lat, depot.lng], 9);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Depot Marker
            const depotIcon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:black;width:12px;height:12px;border-radius:50%;border:2px solid white;'></div>",
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });
            L.marker([depot.lat, depot.lng], {icon: depotIcon}).addTo(map).bindPopup("<b>Depot</b> (จุดกระจายสินค้าสมมติ)");

            // Truck Colors
            const colors = ['#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080'];
            const truckColors = {};
            Object.keys(groups).forEach((id, i) => truckColors[id] = colors[i % colors.length]);

            // Draw Points
            data.forEach(p => {
                const color = truckColors[p.newTruck] || '#999';
                const isChanged = p.oldTruck !== p.newTruck;
                
                L.circleMarker([p.lat, p.lng], {
                    radius: 6,
                    fillColor: color,
                    color: '#fff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                })
                .bindTooltip(p.newTruck, { className: 'my-tooltip', direction: 'top', offset: [0,-5] })
                .bindPopup(`
                    <div style="font-family:'Sarabun'">
                        <b>${p.name}</b><br>
                        <hr style="margin:5px 0; border:0; border-top:1px solid #eee;">
                        <span style="color:#6b7280; font-size:0.8rem;">รถคันใหม่ (K-Means):</span> <b style="color:${color}">${p.newTruck}</b><br>
                        <span style="color:#6b7280; font-size:0.8rem;">รถคันเดิม:</span> <b>${p.oldTruck}</b>
                        ${isChanged ? '<br><span style="color:#dc2626; font-size:0.75rem; font-weight:bold;">(มีการย้ายโซน)</span>' : ''}
                    </div>
                `)
                .addTo(map);
            });

            // Legend
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = '<strong style="display:block; margin-bottom:5px;">โซนรถ (ใหม่)</strong>';
                Object.keys(truckColors).sort().forEach(id => {
                    div.innerHTML += `<div><i style="background:${truckColors[id]}"></i> ${id}</div>`;
                });
                return div;
            };
            legend.addTo(map);
        }

        // Start
        initDashboard();

    </script>
</body>
</html>
